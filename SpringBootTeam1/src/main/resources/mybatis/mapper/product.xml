<?xml version="1.0" encoding="euc-kr" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mycompany.webapp.dao.ProductDao">
   <!-- ResultMap --> 
   <resultMap type="product" id="productMap">
      <id property="p_id" column="p_id"/>
      <result property="p_name" column="p_name"/>
      <result property="p_rate" column="p_rate"/>       
      <result property="p_price" column="p_price"/>
      <result property="p_stock" column="p_stock"/>
      <result property="p_salescount" column="p_salescount"/>
      <result property="p_category_name" column="p_category_name"/>
      <result property="p_upload_date" column="p_upload_date"/>
      <result property="p_description" column="p_description"/>   
      
       
       <collection property="photolist" ofType="photo">
          <result property="photo_id" column="photo_id"/>
         <result property="p_id" column="p_id"/>
         <result property="photo_oname" column="photo_oname"/>
         <result property="photo_sname" column="photo_sname"/>
         <result property="photo_type" column="photo_type"/>
         <result property="photo_role" column="photo_role"/>
       </collection>         
   </resultMap> 
    
   
   
   
   <resultMap type="product" id="productDetailMap">
      <id property="p_id" column="p_id"/>
      <result property="p_name" column="p_name"/>
      <result property="p_rate" column="p_rate"/>
      <result property="p_price" column="p_price"/>
      <result property="p_stock" column="p_stock"/>
      <result property="p_salescount" column="p_salescount"/>
      <result property="p_category_name" column="p_category_name"/>
      <result property="p_upload_date" column="p_upload_date"/>
      <result property="p_description" column="p_description"/>   
      
      
       <collection column="p_id" property="photolist" ofType="photo" javaType="List" select="getPhotoList">
          <id property="photo_id" column="photo_id"/>
         <result property="p_id" column="p_id"/>
         <result property="photo_oname" column="photo_oname"/>
         <result property="photo_sname" column="photo_sname"/>
         <result property="photo_type" column="photo_type"/>
         <result property="photo_role" column="photo_role"/>
       </collection>
       
       
       
       <collection column="p_id" property="sizelist" ofType="size" javaType="List" select="getSizeList">
         <id property="p_size" column="p_size"/> 
           <id property="p_id" column="p_id"/>
       </collection>
         
   </resultMap> 
   
   <select id="getPhotoList" parameterType="int" resultType="photo">
      select *
      from photos
      where p_id=#{p_id}
    </select>

   <select id="getSizeList" parameterType="int" resultType="size">
      select *
      from size_products
      where p_id=#{p_id}
    </select>
    
    <select id="selectcurrent"  resultType="int">
       SELECT MAX(p_id) FROM products p
   </select>
    
    
       <update id="update" parameterType="product">
      update products set p_id=#{p_id}, p_name=#{p_name}, p_price=#{p_price}, p_stock=#{p_stock}, p_salescount=#{p_salescount}, p_category_name=#{p_category_name},
      p_upload_date=sysdate, p_description=#{p_description}
      where p_id=#{p_id}
      </update>
    
        <update id="updateEnabledBypid" parameterType="int">
         update products set p_enabled=0
         where p_id=#{p_id}
         </update>
       
    
        <delete id="deleteBypid" parameterType="int">
         delete from products
         where p_id=#{p_id}
         </delete>
         
         <select id="countSort" resultType="int">
         select count(*) from products
         <if test="countSort == '전체'">
         where p_enabled=1
         </if>
         <if test="countSort == '재고부족'">
         where p_enabled=1 and p_stock=0
         </if>
         
         </select>
   <!-- 상품 insert / seq로 상품 id-->
   <insert id="insert" parameterType="product">
   <selectKey keyProperty="p_id" resultType="int" order="BEFORE">
      (SELECT NVL(MAX(p_id),0)+1 FROM products p)
   
   </selectKey>
      insert into products
      (p_id, p_name, p_price, p_stock, p_category_name,p_salescount,
      p_upload_date, p_description)
      values
      (#{p_id}, #{p_name}, #{p_price}, #{p_stock},  #{p_category_name},#{p_salescount},
      sysdate, #{p_description})
   </insert>
   
 
<!-- 상품 뿌려주기 select-->
   <select id="selectBypid" parameterType="int" resultType="product">
      select p_id, p_name,p_rate,p_price, p_stock, p_category_name, p_description
      from products
      where p_id=#{pid}
   </select>
     
   <select id="selectAllByPager"  resultType="product" resultMap="productMap">
   
    select rnum, p_id,p_name,p_rate,p_price,p_category_name, p_upload_date,p_stock, photo_sname, photo_type
      from (
          select rownum as rnum,p_id, p_name,p_rate,p_price,p_category_name, p_upload_date,p_stock, photo_sname, photo_type
          from (
               select p.p_id,p.p_name,p.p_rate,p.p_price,p.p_category_name, p.p_upload_date,p.p_stock, ph.photo_sname,ph.photo_type 
              from products p left Join photos ph
              on p.p_id = ph.p_id and
              ph.photo_role='main'
           where p.p_enabled=1
            <if test="optionVal == '번호순'">
              order by p.p_id desc
              </if>
              <if test="optionVal == '재고순'">
              order by p.p_stock
              </if>
              
          )
          where rownum &lt;= #{pager.endRowNo}
      )
      where rnum &gt;= #{pager.startRowNo}  
   </select>
   
   <select id="count" resultType="int">
      select count(*) from products where p_enabled=1
   </select>
   
   
       
       <select id="selectProductDetail" parameterType="int" resultMap="productDetailMap">
      select *
   from products
   where p_id=#{pid}
      </select>
       

   
   
</mapper>